import React, { useState, useRef } from 'react';
import { Camera, X, Loader2, Languages, Play, Square, FileImage, Maximize2 } from 'lucide-react';

export default function MangaScreenTranslator() {
  const [isCapturing, setIsCapturing] = useState(false);
  const [capturedImage, setCapturedImage] = useState(null);
  const [translation, setTranslation] = useState('');
  const [translating, setTranslating] = useState(false);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const streamRef = useRef(null);

  const startCapture = async () => {
    try {
      const stream = await navigator.mediaDevices.getDisplayMedia({
        video: { 
          mediaSource: 'screen',
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      });
      
      streamRef.current = stream;
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        videoRef.current.play();
      }
      
      setIsCapturing(true);
    } catch (error) {
      alert('Erro ao capturar tela. Certifique-se de dar permiss√£o.');
      console.error('Erro:', error);
    }
  };

  const captureFrame = () => {
    if (!videoRef.current || !canvasRef.current) return;

    const video = videoRef.current;
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const imageData = canvas.toDataURL('image/jpeg', 0.9);
    setCapturedImage(imageData);
    stopCapture();
    translateImage(imageData);
  };

  const stopCapture = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    setIsCapturing(false);
  };

  const translateImage = async (base64Image) => {
    setTranslating(true);
    
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1500,
          messages: [
            {
              role: "user",
              content: [
                {
                  type: "image",
                  source: {
                    type: "base64",
                    media_type: "image/jpeg",
                    data: base64Image.split(',')[1]
                  }
                },
                {
                  type: "text",
                  text: "Por favor, extraia e traduza todo o texto desta imagem de manga/manhwa/webtoon para portugu√™s brasileiro. Organize a tradu√ß√£o de forma clara e numerada, indicando cada bal√£o de fala na ordem de leitura (direita para esquerda para manga japon√™s, cima para baixo para manhwa/webtoon). Traduza tamb√©m onomatopeias e efeitos sonoros."
                }
              ]
            }
          ]
        })
      });

      const data = await response.json();
      const textContent = data.content
        .filter(item => item.type === 'text')
        .map(item => item.text)
        .join('\n');
      
      setTranslation(textContent || 'Nenhum texto encontrado na imagem.');
    } catch (error) {
      setTranslation('Erro ao traduzir. Verifique sua conex√£o e tente novamente.');
      console.error('Erro:', error);
    } finally {
      setTranslating(false);
    }
  };

  const reset = () => {
    setCapturedImage(null);
    setTranslation('');
    stopCapture();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-4">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="text-center mb-6 pt-4">
          <div className="flex items-center justify-center gap-3 mb-2">
            <Maximize2 className="w-8 h-8 text-purple-300" />
            <h1 className="text-3xl font-bold text-white">Tradutor de Tela</h1>
          </div>
          <p className="text-purple-200 text-sm">
            Capture a tela do manga/manhwa e traduza instantaneamente
          </p>
        </div>

        {/* Main Content */}
        {!isCapturing && !capturedImage && (
          <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-8 text-center">
            <div className="max-w-md mx-auto">
              <Camera className="w-20 h-20 text-purple-300 mx-auto mb-6" />
              <h2 className="text-2xl font-bold text-white mb-4">
                Como Usar:
              </h2>
              <div className="text-left text-white/90 space-y-3 mb-8">
                <p className="flex items-start gap-2">
                  <span className="text-purple-400 font-bold">1.</span>
                  Abra o site do manga/manhwa em outra aba
                </p>
                <p className="flex items-start gap-2">
                  <span className="text-purple-400 font-bold">2.</span>
                  Clique em "Iniciar Captura de Tela"
                </p>
                <p className="flex items-start gap-2">
                  <span className="text-purple-400 font-bold">3.</span>
                  Selecione a aba ou janela do manga
                </p>
                <p className="flex items-start gap-2">
                  <span className="text-purple-400 font-bold">4.</span>
                  Clique em "Capturar e Traduzir" quando quiser
                </p>
              </div>
              <button
                onClick={startCapture}
                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-2xl flex items-center justify-center gap-3 text-lg"
              >
                <Play className="w-6 h-6" />
                Iniciar Captura de Tela
              </button>
              <p className="text-purple-300 text-xs mt-4">
                ‚ö†Ô∏è Funciona melhor no Chrome/Edge. Safari pode ter limita√ß√µes.
              </p>
            </div>
          </div>
        )}

        {/* Capturing Mode */}
        {isCapturing && (
          <div className="space-y-4">
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl overflow-hidden">
              <div className="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                  <span className="font-semibold">Capturando tela...</span>
                </div>
                <button
                  onClick={stopCapture}
                  className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-all flex items-center gap-2"
                >
                  <Square className="w-4 h-4" />
                  Parar
                </button>
              </div>
              
              <div className="p-4">
                <video
                  ref={videoRef}
                  className="w-full rounded-lg shadow-lg"
                  autoPlay
                  muted
                />
              </div>
            </div>

            <button
              onClick={captureFrame}
              className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-8 rounded-xl transition-all shadow-2xl flex items-center justify-center gap-3 text-lg"
            >
              <Camera className="w-6 h-6" />
              Capturar e Traduzir Agora
            </button>
          </div>
        )}

        {/* Result */}
        {capturedImage && (
          <div className="grid md:grid-cols-2 gap-4">
            {/* Image */}
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl overflow-hidden">
              <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-3 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <FileImage className="w-5 h-5" />
                  <span className="font-semibold">Imagem Capturada</span>
                </div>
                <button
                  onClick={reset}
                  className="bg-red-600 hover:bg-red-700 p-2 rounded-lg transition-all"
                >
                  <X className="w-4 h-4" />
                </button>
              </div>
              <div className="p-4">
                <img
                  src={capturedImage}
                  alt="Captured"
                  className="w-full rounded-lg shadow-lg"
                />
              </div>
            </div>

            {/* Translation */}
            <div className="bg-white/10 backdrop-blur-lg rounded-2xl overflow-hidden">
              <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 flex items-center gap-2">
                <Languages className="w-5 h-5" />
                <span className="font-semibold">Tradu√ß√£o</span>
              </div>
              <div className="p-4 min-h-[300px] max-h-[600px] overflow-y-auto">
                {translating ? (
                  <div className="flex flex-col items-center justify-center py-12">
                    <Loader2 className="w-12 h-12 text-purple-300 animate-spin mb-4" />
                    <span className="text-white text-lg">Traduzindo...</span>
                    <span className="text-purple-300 text-sm mt-2">Isso pode levar alguns segundos</span>
                  </div>
                ) : (
                  <div className="text-white whitespace-pre-wrap leading-relaxed text-base">
                    {translation || 'Aguardando tradu√ß√£o...'}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {capturedImage && (
          <button
            onClick={reset}
            className="w-full mt-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-xl transition-all"
          >
            Nova Captura
          </button>
        )}

        {/* Hidden Canvas */}
        <canvas ref={canvasRef} className="hidden" />

        {/* Tips */}
        <div className="mt-6 bg-white/10 backdrop-blur-lg rounded-xl p-6">
          <h3 className="text-white font-bold text-lg mb-3">üí° Dicas:</h3>
          <ul className="text-purple-200 text-sm space-y-2">
            <li>‚Ä¢ Funciona com qualquer site: MangaDex, Webtoon, TappyToon, etc.</li>
            <li>‚Ä¢ Voc√™ pode ler normalmente e capturar apenas quando precisar</li>
            <li>‚Ä¢ Para melhor resultado, capture uma p√°gina por vez</li>
            <li>‚Ä¢ A tradu√ß√£o funciona com manga japon√™s, manhwa coreano e manhua chin√™s</li>
          </ul>
        </div>
      </div>
    </div>
  );
}
