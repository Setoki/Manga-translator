<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tradutor de Mangá V3.5 - BALÕES AGRUPADOS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .header { text-align: center; color: white; margin-bottom: 30px; }
    .header h1 { font-size: 32px; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .version { background: rgba(255, 255, 255, 0.3); padding: 8px 20px; border-radius: 20px; font-size: 14px; display: inline-block; font-weight: bold; }
    .card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); margin-bottom: 20px; }
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .setting-box { padding: 15px; background: #f9fafb; border-radius: 10px; }
    .setting-box label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #374151; }
    .setting-box select { width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white; }
    .upload-button { width: 100%; padding: 50px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 12px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; text-align: center; }
    .upload-button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    .upload-button .icon { font-size: 48px; display: block; margin-bottom: 15px; }
    .file-input-hidden { display: none; }
    .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .preview-item { position: relative; border-radius: 10px; overflow: hidden; border: 3px solid #e5e7eb; }
    .preview-item img { width: 100%; height: 150px; object-fit: cover; display: block; }
    .remove-btn { position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .progress-section { margin-top: 20px; }
    .progress-bar { width: 100%; height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s; }
    .progress-text { text-align: center; font-size: 14px; color: #6b7280; font-weight: 500; }
    .result-image { width: 100%; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e5e7eb; }
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .alert { padding: 15px; border-radius: 10px; margin-top: 15px; font-size: 14px; }
    .alert-error { background: #fee2e2; color: #991b1b; border: 2px solid #fca5a5; }
    .alert-info { background: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; }
    .hidden { display: none; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .stat-box { text-align: center; padding: 15px; background: #f9fafb; border-radius: 8px; }
    .stat-number { font-size: 28px; font-weight: bold; color: #667eea; }
    .stat-label { font-size: 12px; color: #6b7280; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🌐 Tradutor de Mangá PRO</h1>
      <div class="version">⚡ V3.5 - BALÕES AGRUPADOS</div>
    </div>

    <div class="card">
      <div class="settings-grid">
        <div class="setting-box">
          <label>🗣️ Idioma de Origem</label>
          <select id="sourceLang">
            <option value="eng">🇺🇸 Inglês</option>
            <option value="por">🇧🇷 Português</option>
            <option value="spa">🇪🇸 Espanhol</option>
          </select>
        </div>
        <div class="setting-box">
          <label>🎯 Traduzir Para</label>
          <select id="targetLang">
            <option value="pt">🇧🇷 Português BR</option>
            <option value="en">🇺🇸 Inglês</option>
            <option value="es">🇪🇸 Espanhol</option>
          </select>
        </div>
      </div>

      <button class="upload-button" id="uploadBtn">
        <span class="icon">📤</span>
        <div>CLIQUE PARA ESCOLHER IMAGENS</div>
        <div style="font-size: 14px; margin-top: 10px; opacity: 0.9;">Até 2 imagens por vez</div>
      </button>
      <input type="file" id="fileInput" class="file-input-hidden" accept="image/*" multiple>
      
      <div id="previewSection" class="hidden">
        <h3 style="margin-top: 20px; margin-bottom: 10px;">📸 Imagens:</h3>
        <div id="previewGrid" class="preview-grid"></div>
        <button class="btn btn-primary" id="translateBtn">🚀 TRADUZIR COM AGRUPAMENTO INTELIGENTE</button>
      </div>

      <div id="progressSection" class="hidden progress-section">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-text" id="progressText">Processando...</div>
      </div>
    </div>

    <div id="resultsSection" class="card hidden">
      <h3 style="text-align: center; color: #10b981; margin-bottom: 20px;">✅ Tradução Concluída!</h3>
      <div class="stats">
        <div class="stat-box"><div class="stat-number" id="statBalloons">0</div><div class="stat-label">Balões</div></div>
        <div class="stat-box"><div class="stat-number" id="statTranslated">0</div><div class="stat-label">Traduções</div></div>
        <div class="stat-box"><div class="stat-number" id="statImages">0</div><div class="stat-label">Imagens</div></div>
      </div>
      <div id="resultsContainer"></div>
      <div class="btn-group">
        <button class="btn btn-success" id="downloadBtn">💾 Baixar</button>
        <button class="btn btn-secondary" id="newBtn">🔄 Nova</button>
      </div>
    </div>

    <div class="alert alert-info">
      <strong>💡 NOVO: Sistema de Agrupamento</strong><br>
      ✨ Agrupa palavras próximas no mesmo balão<br>
      🎯 Traduz o texto completo junto<br>
      📦 Uma caixa por balão (não mais palavras soltas!)
    </div>
    <div id="errorAlert" class="alert alert-error hidden"></div>
  </div>

  <script>
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const previewSection = document.getElementById('previewSection');
    const previewGrid = document.getElementById('previewGrid');
    const translateBtn = document.getElementById('translateBtn');
    const progressSection = document.getElementById('progressSection');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const resultsSection = document.getElementById('resultsSection');
    const resultsContainer = document.getElementById('resultsContainer');
    const statBalloons = document.getElementById('statBalloons');
    const statTranslated = document.getElementById('statTranslated');
    const statImages = document.getElementById('statImages');
    const downloadBtn = document.getElementById('downloadBtn');
    const newBtn = document.getElementById('newBtn');
    const sourceLang = document.getElementById('sourceLang');
    const targetLang = document.getElementById('targetLang');
    const errorAlert = document.getElementById('errorAlert');

    let selectedFiles = [];
    let translatedImages = [];
    let totalBalloons = 0;
    let totalTranslated = 0;

    uploadBtn.onclick = () => fileInput.click();

    fileInput.onchange = function(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return showError('Nenhum arquivo!');
      if (files.length > 2) return showError('Máximo 2 imagens!');
      selectedFiles = files;
      displayPreview();
      hideError();
    };

    function displayPreview() {
      previewGrid.innerHTML = '';
      previewSection.classList.remove('hidden');
      selectedFiles.forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = e => {
          const div = document.createElement('div');
          div.className = 'preview-item';
          div.innerHTML = '<img src="' + e.target.result + '"><button class="remove-btn" onclick="removeImage(' + i + ')">×</button>';
          previewGrid.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }

    window.removeImage = i => {
      selectedFiles.splice(i, 1);
      selectedFiles.length === 0 ? (previewSection.classList.add('hidden'), fileInput.value = '') : displayPreview();
    };

    translateBtn.onclick = async function() {
      translateBtn.disabled = true;
      progressSection.classList.remove('hidden');
      resultsSection.classList.add('hidden');
      translatedImages = [];
      totalBalloons = 0;
      totalTranslated = 0;

      try {
        for (let i = 0; i < selectedFiles.length; i++) {
          updateProgress(i, selectedFiles.length, 'Processando ' + (i + 1) + '/' + selectedFiles.length);
          const result = await processWithGrouping(selectedFiles[i], i + 1);
          translatedImages.push(result);
        }
        updateProgress(selectedFiles.length, selectedFiles.length, 'Concluído!');
        showResults();
      } catch (error) {
        showError('Erro: ' + error.message);
        translateBtn.disabled = false;
        progressSection.classList.add('hidden');
      }
    };

    async function processWithGrouping(file, num) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async e => {
          const img = new Image();
          img.onload = async () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            updateProgress(null, null, '🔍 OCR na imagem ' + num + '...');

            try {
              const result = await Tesseract.recognize(canvas, sourceLang.value, {
                logger: m => m.status === 'recognizing text' && updateProgress(null, null, 'OCR: ' + Math.round(m.progress * 100) + '%')
              });

              const words = result.data.words.filter(w => w.confidence > 45 && w.text.trim().length > 0);
              console.log('Palavras detectadas:', words.length);

              // AGRUPAR PALAVRAS PRÓXIMAS
              const groups = groupNearbyWords(words, 80);
              console.log('Balões agrupados:', groups.length);
              
              totalBalloons += groups.length;

              for (let i = 0; i < groups.length; i++) {
                const group = groups[i];
                updateProgress(null, null, '🌐 Traduzindo balão ' + (i + 1) + '/' + groups.length);
                
                const fullText = group.words.map(w => w.text).join(' ');
                const translation = await translateText(fullText);
                totalTranslated++;

                // Desenhar UMA caixa para todo o grupo
                drawTextBox(ctx, group.bbox, translation);
              }

              resolve(canvas.toDataURL('image/png'));
            } catch (err) {
              reject(new Error('Falha no OCR'));
            }
          };
          img.onerror = () => reject(new Error('Erro ao carregar imagem'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
        reader.readAsDataURL(file);
      });
    }

    function groupNearbyWords(words, maxDistance) {
      if (words.length === 0) return [];
      
      const groups = [];
      const used = new Set();

      words.forEach((word, i) => {
        if (used.has(i)) return;
        
        const group = {
          words: [word],
          bbox: { ...word.bbox }
        };
        used.add(i);

        // Buscar palavras próximas
        words.forEach((other, j) => {
          if (i === j || used.has(j)) return;
          
          const dist = Math.sqrt(
            Math.pow((word.bbox.x0 + word.bbox.x1)/2 - (other.bbox.x0 + other.bbox.x1)/2, 2) +
            Math.pow((word.bbox.y0 + word.bbox.y1)/2 - (other.bbox.y0 + other.bbox.y1)/2, 2)
          );

          if (dist < maxDistance) {
            group.words.push(other);
            group.bbox.x0 = Math.min(group.bbox.x0, other.bbox.x0);
            group.bbox.y0 = Math.min(group.bbox.y0, other.bbox.y0);
            group.bbox.x1 = Math.max(group.bbox.x1, other.bbox.x1);
            group.bbox.y1 = Math.max(group.bbox.y1, other.bbox.y1);
            used.add(j);
          }
        });

        if (group.words.length > 0) groups.push(group);
      });

      return groups;
    }

    function drawTextBox(ctx, bbox, text) {
      const pad = 8;
      const x = bbox.x0 - pad;
      const y = bbox.y0 - pad;
      const w = bbox.x1 - bbox.x0 + pad * 2;
      const h = bbox.y1 - bbox.y0 + pad * 2;

      // Fundo branco
      ctx.fillStyle = 'rgba(255, 255, 255, 0.98)';
      ctx.fillRect(x, y, w, h);

      // Borda
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.strokeRect(x, y, w, h);

      // Texto
      ctx.fillStyle = '#000';
      const fontSize = Math.max(Math.min(h * 0.4, 16), 12);
      ctx.font = 'bold ' + fontSize + 'px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      // Quebrar linhas
      const words = text.split(' ');
      const lines = [];
      let line = '';
      
      words.forEach(word => {
        const test = line + (line ? ' ' : '') + word;
        if (ctx.measureText(test).width > w - 16 && line) {
          lines.push(line);
          line = word;
        } else {
          line = test;
        }
      });
      if (line) lines.push(line);

      const lineHeight = fontSize * 1.2;
      const startY = y + h / 2 - (lines.length * lineHeight) / 2 + fontSize / 2;

      lines.forEach((l, i) => ctx.fillText(l, x + w / 2, startY + i * lineHeight));
    }

    async function translateText(text) {
      if (!text || text.trim().length === 0) return text;
      const from = getLangCode(sourceLang.value);
      const to = targetLang.value;

      try {
        const url = 'https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=' + from + '|' + to;
        const res = await fetch(url);
        const data = await res.json();
        if (data.responseStatus === 200) return data.responseData.translatedText;
      } catch (e) {}

      return text;
    }

    function getLangCode(code) {
      const map = { 'eng': 'en', 'por': 'pt', 'spa': 'es' };
      return map[code] || code;
    }

    function updateProgress(current, total, msg) {
      if (current !== null && total !== null) progressFill.style.width = (current / total) * 100 + '%';
      progressText.textContent = msg;
    }

    function showResults() {
      resultsSection.classList.remove('hidden');
      resultsContainer.innerHTML = '';
      statBalloons.textContent = totalBalloons;
      statTranslated.textContent = totalTranslated;
      statImages.textContent = translatedImages.length;
      translatedImages.forEach((src, i) => {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'result-image';
        resultsContainer.appendChild(img);
      });
      progressSection.classList.add('hidden');
      previewSection.classList.add('hidden');
      translateBtn.disabled = false;
    }

    function showError(msg) {
      errorAlert.textContent = '❌ ' + msg;
      errorAlert.classList.remove('hidden');
    }

    function hideError() {
      errorAlert.classList.add('hidden');
    }

    downloadBtn.onclick = () => {
      translatedImages.forEach((src, i) => {
        const a = document.createElement('a');
        a.href = src;
        a.download = 'manga-' + (i + 1) + '.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });
    };

    newBtn.onclick = () => location.reload();

    console.log('✅ V3.5 - Sistema de agrupamento ativado!');
  </script>
</body>
</html>
